!function(e,t){for(var r in t)e[r]=t[r]}(exports,function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=9)}([function(e,t){e.exports=require("tslib")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("function-bind")},function(e,t){e.exports=require("define-properties")},function(e,t){e.exports=require("es-abstract/es7")},function(e,t,r){"use strict";var n=r(3),o=r(5),s=n.call(Function.call,String.prototype.slice);e.exports=function(e){var t,r=o.RequireObjectCoercible(this),n=o.ToString(r),a=o.ToLength(n.length);arguments.length>1&&(t=arguments[1]);var i=void 0===t?"":o.ToString(t);""===i&&(i=" ");var u=o.ToLength(e);if(u<=a)return n;for(var l=u-a;i.length<l;){var c=i.length,f=l-c;i+=c>f?s(i,0,f):i}return(i.length>l?s(i,0,l):i)+n}},function(e,t,r){"use strict";var n=r(6);e.exports=function(){return"function"==typeof String.prototype.padStart?String.prototype.padStart:n}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),o=r(17);t.createJar=(()=>o.jar()),t.default=(e=>{const t=r=>n.__awaiter(this,void 0,void 0,function*(){const n="string"==typeof r?{uri:r}:r,s=Date.now(),a=yield o(Object.assign({},n,{followAllRedirects:!0,jar:e,gzip:!0,resolveWithFullResponse:!0,timeout:15e3}));return t.calls.push(Object.assign({},n,{contentLength:a.body.length,time:Date.now()-s})),a.body});return t.calls=[],t.reset=(()=>{t.calls=[]}),t})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),o=r(10),s=r(11),a=r(2),i=r(1),u=r(12),l=r(14),c=r(15),f=r(16),p=r(8),d=r(18),m=r(21),g=r(22),h=r(26),y=r(27);const v=e=>{const t=new RegExp(e.source||".","i");return e=>t.test(e.name)},b=e=>{const t=i.flatten(e._.map(e=>s.categoryGroups[e]||e)),r=new RegExp(`\\b(${t.join("|")})`);return e=>r.test(e.fixtureId)},x=e=>{const t={};return e.map(e=>(t[e.category]=(t[e.category]||0)+1,{profile:e,fixtureId:["(",e.category,"-",u(t[e.category],2,"0"),")"].join("")}))},_=(e,t)=>t.smoke?[{min:0,max:s.radiusStepsForProfile(e).find(e=>e>=25)}]:i.aperture(2,s.radiusStepsForProfile(e)).map(([e,t])=>({min:e,max:t}));t.default=function(e){return n.__awaiter(this,void 0,void 0,function*(){if(!d.default)return;!function(){if(l.inspect.styles=Object.assign({},l.inspect.styles,{number:"blue",boolean:"blue"}),!d.default.bloody){const e=r(28);e.fixtures="./replay",d.default.record?e.mode="record":d.default.cheat?e.mode="cheat":e.mode="replay"}}();const t=b(d.default),s=v(d.default),u=m.default(),S=(new Date).getTime(),O=d.default.fixtures?r(29)(d.default.fixtures).default:o.fixtures,j=x(O(o.fixtureHelpers,d.default)).filter(t).map(t=>n.__awaiter(this,void 0,void 0,function*(){const r=t.profile,n=p.createJar(),o=function(e,t){return e({enableHilton:!1,enableChunking:!1,endpointApi:"https://sources.findy.com",enableDelivery:!0}).run(t)}(e,r),a={};let u=[];const l=_(r,d.default);for(let e of l){const r=o({radius:e}).filter(s);u=u.concat(i.flatten(yield Promise.all(r.map(r=>g.default(r,e,n,d.default,a,t.fixtureId)))))}if(u.length>0)return f.default(r,u,t.fixtureId,d.default)})),w=(yield Promise.all(j)).filter(Boolean);a.existsSync("./reports")||a.mkdirSync("./reports"),a.writeFileSync(`./reports/${u}.json.gz`,c.gzipSync(JSON.stringify(w))),d.default.prometheus&&y.default(w,S),d.default.report&&console.log(JSON.stringify(h.getReport(),null,2)),console.log(`Saved report file ${u}.json.gz`)})}},function(e,t){e.exports=require("@findy-sources/fixtures")},function(e,t){e.exports=require("@findy-sources/meta")},function(e,t,r){"use strict";var n=r(3),o=r(4),s=r(5),a=r(6),i=r(7),u=r(13),l=n.call(Function.apply,a),c=function(e,t){s.RequireObjectCoercible(e);var r=[t];return arguments.length>2&&r.push(arguments[2]),l(e,r)};o(c,{getPolyfill:i,implementation:a,shim:u}),e.exports=c},function(e,t,r){"use strict";var n=r(7),o=r(4);e.exports=function(){var e=n();return o(String.prototype,{padStart:e},{padStart:function(){return String.prototype.padStart!==e}}),e}},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("zlib")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(1),o=n.pipe(n.groupBy(n.path(["radius","max"])),n.values),s=n.pipe(n.groupBy(n.prop("iteratorName")),n.values),a=e=>({count:n.sum(e.map(e=>e.values.length)),pages:e.filter(i).length,trash:n.sum(e.map(e=>e.discards.length)),seen:n.sum(e.map(e=>e.seen)),calls:n.sum(e.map(e=>e.calls.length)),estimated:Math.max(...e.map(e=>e.estimatedTotal||0))}),i=e=>!e.exhausted;t.default=((e,t,r,u)=>({profile:e,iterators:s(t).map(e=>{let t=u["limit-values"];const r=e=>{if(t<1)return n.omit("values",e);{const r=n.assoc("values",e.values.slice(0,t),e);return t-=r.values.length,r}};return{name:n.head(e).iteratorName,exhausted:n.last(e).exhausted,error:n.last(e).error,totals:a(e),radiuses:o(e).map(e=>({radius:n.head(e).radius,totals:a(e),steps:e.filter(i).map(n.omit(["radius","iteratorName"])).map(r)}))}}),fixtureId:r}))},function(e,t){e.exports=require("request-promise-native")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(19),o=r(20),s=n(process.argv.slice(2),{string:["_"],boolean:["nocolor"],default:{delay:0,"limit-values":100,"stop-after-count":300,"stop-after-step":100}});let a=!0;s["check-images"]&&!s.bloody&&(console.log("Option --check-images requires --bloody option to be enabled."),a=!1),s.smoke&&(console.log("--smoke option is removed. Use --stop-after-step=1"),a=!1),s.parallel&&(s.perf||s.snapshot)&&(console.log("Option --parallel can't be used with --perf or --snapshot"),a=!1),s.h&&(o.default(),a=!1),t.default=a?s:void 0},function(e,t){e.exports=require("minimist")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=(()=>{console.log("\nUsage: yarn start -- [pattern] [flags]\n  \nPattern: \n  Any substring from profile or profile id\n   \nFlags:\n  --snapshot=[r][v][u] - test iteration data with snapshots, if some snapshot is not found - create it\n    r - test http requests\n    v - test found values\n    u - update snapshots without checking\n  --record - save new http request to the cache\n  --bloody - ignore cache while making http requests\n  --source=[source name substring] - run only matched sources \n  --check-images - tries to download every image listed in photoUrl and reports on fails\n  --report - shows report on used sources and filters\n  --parallel - run all iterators of the profile at the same time\n  --delay=[seconds] - delay after request\n  --nocolor - do not use colors in output, useful for file output.\n  --backend - enable backend tests\n  --fixtures=[filename] - custom fixtures file. For usage check ./src/fixtures.ts\n  --limit-values=<n> - max number of good values to include in report. Default: 100\n  --stop-after-count=<n> - stop test after given number of good values the source. Default: 300\n  --stop-after-step=<n> - stop test after given number of steps. Default: 100 \n  --prometheus - additionally export to prometheus format\n")})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=(()=>(new Date).toISOString().replace(/(\.\d\d\d)|\W/g,""))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),o=r(23),s=r(24),a=r(8),i=r(25);function u(e,t){return!e.error&&e.seenIds.size<t["stop-after-count"]&&e.steps<t["stop-after-step"]}s.into(console);const l={};function c(e){const t=/\S*/.exec(e)[0];return l[t]=l[t]||new o.Mutex,l[t]}function f(e,t){t.forEach(t=>e.seenIds.add(t.id)),e.steps++}function p(e){const t=console.draft(e);let r={};return n=>{r=Object.assign({},r,n),t(e+(r.phase||"").padEnd(10," ")+(r.error?r.error.split("\n")[0]:"")+(void 0!==r.count?r.count:"")+(r.exhausted?"exhausted":""))}}t.default=function(e,t,r,o,s,l){return n.__awaiter(this,void 0,void 0,function*(){let n=null;const d=[],m={iteratorName:e.name,radius:t,values:[],discards:[],warnings:[],calls:[],selfTime:0,seen:0},g=function(e,t){return t[e]=t[e]||{seenIds:new Set,steps:0,error:!1},t[e]}(e.name,s);let h=0;const y=a.default(r);let v;try{for(;u(g,o);){h++;const r=l.padEnd(30," ")+e.name.padEnd(30," ")+`${t.min}..${t.max}`.padEnd(10," ")+`#${h}`.padEnd(4," "),s=yield c(e.name).acquire();(v=p(r))({phase:"run"});try{y.reset();const t=Date.now(),r=yield e.iterate(n,y);n=r.context,d.push(Object.assign({},m,r,{calls:y.calls,selfTime:Date.now()-t})),v({count:r.values.length}),f(g,r.values)}finally{v({phase:"cooldown"}),i.default(o.delay).then(()=>{s(),v({phase:"done"})})}}}catch(e){let t;"EXHAUSTED"===e?(v({exhausted:!0}),d.push(Object.assign({},m,{exhausted:!0,calls:y.calls}))):t=e.toString().match("ESOCKETTIMEDOUT")?`Timeout on ${e.options.method} ${e.options.uri}`:e.toString().match("StatusCodeError")?`Status code ${e.toString().match(/^StatusCodeError: (\d+)/)[1]}`:e.stack||String(e),t&&(v({error:t}),function(e){e.error=!0}(g),d.push(Object.assign({},m,{error:t,calls:y.calls})))}return d})}},function(e,t){e.exports=require("await-semaphore")},function(e,t){e.exports=require("draftlog")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return new Promise(t=>{setTimeout(t,1e3*e)})}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),o=r(1);let s={};t.getReport=(()=>s);const a=e=>e.match(/^(https?:\/\/.*?)\//)[1],i=(e,t)=>{if(Array.isArray(e)&&Array.isArray(t))return o.uniq(o.concat(e,t));throw"Expected array"};t.default=((e,t,r,u)=>n.__awaiter(this,void 0,void 0,function*(){if(!u.report)return;const t="findy"===r.name,n={any:{apiDomains:r.calls.map(e=>a(e.uri)),[t?"findyImageDomains":"otherImageDomains"]:r.values.map(e=>a(e.photoUrl))},[e.category]:{domains:o.uniq(r.calls.map(e=>a(e.uri))),filters:Object.keys(e.attributes||{}).concat(o.without(["attributes","geolocation","category"],Object.keys(e)))}};s=o.mergeDeepWith(i,s,n)}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(2),o=r(1),s=["count","pages","calls","trash","seen","estimated"],a="external_sources_iterator",i=e=>`{${Object.entries(e).map(([e,t])=>`${e}=${JSON.stringify(String(t))}`).join(",")}}`;t.default=((e,t)=>(e=>{n.writeFileSync("./reports/prometheus.txt",e)})(((e,t)=>{const r=s.map(e=>`# TYPE ${a}_totals_${e} counter`),n=e.map(e=>e.iterators.map(t=>{const r={name:t.name,category:e.profile.category,fixtureId:e.fixtureId.slice(1,-1)},n=s.map(e=>`${a}_totals_${e}${i(r)} ${t.totals[e]}`),o=t.error?t.error:"no errors",u=t.error?1:0;return[n,`${a}_error_${i(Object.assign({},r,{error:o}))} ${u}`]})),u=`external_sources_last_success_unixtime ${t}`;return o.flatten([r,n,u]).join("\n")+"\n"})(e,t)))},function(e,t){e.exports=require("replay")},function(e,t){function r(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=29}]));